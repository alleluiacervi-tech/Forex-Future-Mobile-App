generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderSide {
  buy
  sell
}

enum OrderStatus {
  filled
  pending
  canceled
}

enum TransactionType {
  trade
  deposit
  withdrawal
}

enum RiskLevel {
  conservative
  moderate
  aggressive
}

model User {
  id            String      @id @default(uuid())
  name          String
  email         String      @unique
  passwordHash  String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  baseCurrency  String      @default("USD")
  riskLevel     RiskLevel   @default(moderate)
  notifications Boolean     @default(true)
  trialActive   Boolean     @default(false)
  trialStartedAt DateTime?
  account       Account?
  positions     Position[]
  orders        Order[]
  transactions  Transaction[]
  watchlist     Watchlist?
  recommendations Recommendation[]
  paymentMethods PaymentMethod[]
}

model Account {
  id         String   @id @default(uuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String   @unique
  balance    Float    @default(100000)
  equity     Float    @default(100000)
  marginUsed Float    @default(0)
  currency   String   @default("USD")
  updatedAt  DateTime @updatedAt
}

model Position {
  id           String   @id @default(uuid())
  user         User     @relation(fields: [userId], references: [id])
  userId       String
  pair         String
  side         OrderSide
  units        Float
  entryPrice   Float
  openTime     DateTime @default(now())
  unrealizedPnl Float   @default(0)
}

model Order {
  id        String      @id @default(uuid())
  user      User        @relation(fields: [userId], references: [id])
  userId    String
  pair      String
  side      OrderSide
  units     Float
  price     Float
  status    OrderStatus @default(filled)
  createdAt DateTime    @default(now())
}

model Transaction {
  id        String          @id @default(uuid())
  user      User            @relation(fields: [userId], references: [id])
  userId    String
  type      TransactionType
  pair      String?
  side      OrderSide?
  units     Float?
  price     Float?
  timestamp DateTime        @default(now())
}

model Watchlist {
  id     String   @id @default(uuid())
  user   User     @relation(fields: [userId], references: [id])
  userId String   @unique
  pairs  String[]
}

model Recommendation {
  id               String   @id @default(uuid())
  user             User     @relation(fields: [userId], references: [id])
  userId           String
  pair             String
  action           String
  confidence       Float
  entry            Float?
  stopLoss         Float?
  takeProfit1      Float?
  takeProfit2      Float?
  riskReward       String?
  positionSizeLots Float?
  rationale        String
  createdAt        DateTime @default(now())
}

model PaymentMethod {
  id                String   @id @default(uuid())
  user              User     @relation(fields: [userId], references: [id])
  userId            String
  provider          String   @default("card")
  brand             String?
  last4             String
  expMonth          Int
  expYear           Int
  holderName        String?
  billingPostalCode String?
  isDefault         Boolean  @default(false)
  token             String?  @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}

model MarketCandle {
  id          String   @id @default(uuid())
  pair        String
  interval    String
  bucketStart DateTime
  open        Float
  high        Float
  low         Float
  close       Float
  volume      Float    @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([pair, interval, bucketStart])
  @@index([pair, interval, bucketStart])
}

model MarketAlert {
  id            String   @id @default(uuid())
  pair          String
  windowMinutes Int
  fromPrice     Float
  toPrice       Float
  changePercent Float
  severity      String
  triggeredAt   DateTime @default(now())
  createdAt     DateTime @default(now())

  @@index([pair, triggeredAt])
}
